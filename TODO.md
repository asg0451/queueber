# TODOs (beyond inline comments)

- [X] (minor) make newtype safety stuff for db keys
- [X] (minor) set the rocksdb setting that helps with prefix scans
- [X] (minor) proper command setup (cli args, etc)
- [X] (minor) ci
- [ ] (minor) rocksdb settings tuning
- [X] (major) server concurrency (either normally or via partitioning)
- [X] (major) server parallelism
- [ ] (major) server/storage sharding
- [X] (major) move storage to an io thread pool
- [X] (feat) implement lease expiry via a background thread
- [X] (feat) implement poll in server
- [X] (minor) add polling timeout and num_items options
- [X] (major) fix race condition: concurrent polls can hand out the same messages
- [X] (feat) implement remove
- [ ] (feat) implement extend
- [X] (bugfix) e2e benchmark hangs / improve benchmarks
- [X] (bugfix) polling returns early if it's woken by a new message being added, *even if it isnt visible*.
- [X] (bugfix) poll-waiting isnt interrupted when a message becomes visible
- [X] (minor) clean up cursed client stress mode
- [ ] (minor) perf analysis on queueber while being stressed
- [X] (minor) integrate tokio console into queueber
- [X] (bugfix) stress test found this error with num workers = 4: `database integrity violated: main key not found`. fix it.
- [ ] (perf) improve performance and cpu utilization. see docs/perf-notes.md
  - [ ] (perf) add `--workers` CLI flag and name RPC worker threads
  - [ ] (perf) log top-level Tokio runtime metrics at startup (requires `--cfg tokio_unstable`)
  - [ ] (perf) offload blocking RocksDB work from RPC thread:
    - [X] `add()` already uses `spawn_blocking`
    - [ ] `poll()` wraps `get_next_available_entries_with_lease` in `spawn_blocking`
    - [ ] `remove()` wraps `remove_in_progress_item` in `spawn_blocking`
    - [ ] `extend()`?
    - [ ] (perf) improve wakeups: replace `Notify` with a versioned `watch<u64>` epoch channel to avoid lost wakeups and stampedes
    - [ ] (perf) de-duplicate background tasks: run single `lease_expiry` and `visibility_wakeup` in top-level runtime
    - [ ] (perf) batch DB moves in `get_next_available_entries_with_lease` into a single transaction
    - [ ] (perf) RocksDB tuning: increase parallelism/background jobs and add bloom filters
    - [ ] (perf) switch to unpacked Capâ€™n Proto serialization (`capnp::serialize`) everywhere
    - [ ] (perf) per-worker accept via `SO_REUSEPORT`
    - [ ] (perf) buffer/message reuse to reduce allocations on hot paths (if that makes sense for capnp)
