# TODOs (beyond inline comments)

- [X] (minor) make newtype safety stuff for db keys
- [X] (minor) set the rocksdb setting that helps with prefix scans
- [X] (minor) proper command setup (cli args, etc)
- [X] (minor) ci
- [X] (major) server concurrency (either normally or via partitioning)
- [X] (major) server parallelism
- [X] (major) move storage to an io thread pool
- [X] (feat) implement lease expiry via a background thread
- [X] (feat) implement poll in server
- [X] (minor) add polling timeout and num_items options
- [X] (major) fix race condition: concurrent polls can hand out the same messages
- [X] (feat) implement remove
- [X] (feat) implement extend
- [X] (bugfix) e2e benchmark hangs / improve benchmarks
- [X] (bugfix) polling returns early if it's woken by a new message being added, *even if it isnt visible*.
- [X] (bugfix) poll-waiting isnt interrupted when a message becomes visible
- [X] (minor) clean up cursed client stress mode
- [X] (minor) integrate tokio console into queueber
- [X] (bugfix) stress test found this error with num workers = 4: `database integrity violated: main key not found`. fix it.
- [ ] (minor) perf analysis on queueber while being stressed
- [X] (minor) make sure all storage stuff happens within a spawn_blocking or similar
- [ ] (minor) rocksdb settings tuning
- [X] (test) add extend to fuzz test and stress
- [ ] (major) server/storage sharding
- [ ] (major) fix server parallelism -- it's not right currently
- [X] (major) make sure there's only one copy of each background task running in the system
- [X] (bugfix) why does the server just shut down under stress after a while with exit code 0 ...
- [X] (perf) add `--workers` CLI flag and name RPC worker threads
- [ ] (perf) improve performance
  - (likely win) add iterator upper bounds to time-ordered scans (`visibility_index`, `lease_expiry_index`) to stop at now [implemented]
  - (likely win) batch main value reads via `multi_get` in poll; batch writes where feasible
  - [X] (likely win) reuse Cap'n Proto builders and byte buffers to cut allocations on hot paths
  - (likely win) avoid reserializing `stored_item` during expiry; update index only or decouple index key from value
  - guard expensive debug logging/UUID formatting behind level checks; sample logs under load
  - evaluate pessimistic transactions under contention; compare retries vs lock waits
  - reduce redundant copies (to_vec, id conversions); prefer borrowing/Arc reuse across async boundaries
  - pre-size vectors/lists based on `n` to avoid reallocs in poll and lease building
  - [X] (likely win) split RocksDB namespaces into column families; see `docs/rocksdb-column-families.md`
- [ ] (perf) improve poll wakeups
- [X] (perf) per-worker accept via `SO_REUSEPORT`
- [ ] (perf) buffer/message reuse to reduce allocations on hot paths (if that makes sense for capnp)
- [X] (minor) rename keys to ids in `LeaseEntry`, or actually put keys in there. either way
- [X] (minor) make `add_available_item_from_parts` wrap `add_available_items_from_parts`, not the other way around
- [ ] (minor) use a mockable clock when generating uuidv7s
- [ ] (perf) reduce unnecessary allocs, such as when copying data or allocating buffers. some is called out in code comments
- [X] (perf) sort the keys in `LeaseEntry` so we can do bsearch on them
- [X] (major) ensure `extend` doesnt create multiple index entries for the same lease.
- [X] (perf) add lease expiry index key to `LeaseEntry` so we don't have to do scans to find it when extending
- [X] (bugfix) i still get `assertion failed: main key not found: [97, 118, 97, 105, 108, 97, 98, 108, 101, 47, 1, 152, 216, 213, 36, 239, 114, 179, 154, 59, 190, 29, 213, 115, 111, 117]"` from poll requests when running with high concurrency. even now that we use a snapshotted txn in poll.
- [X] (perf) implement poll request coalescing to reduce contention - when multiple clients are polling simultaneously, batch their requests to reduce database contention and improve throughput ([sketch](docs/poll_coalescing_sketch.md))
- [X] (ci/perf) compare PR benchmark summary vs latest master artifact and post delta table in PR
- [ ] (productionize) add lightweight prometheus metrics for key SLIs and rocksdb stuff
- [ ] (testing) test startup recovery / durability
- [X] (testing) extend property/fuzz tests to RPC surface with failure injection
- [ ] (feat) multiple-queues/namespaces with per-queue isolation and limits
- [X] (productionize) implement graceful shutdown: handle SIGTERM/SIGINT, stop accepting, drain in-flight RPCs, signal background tasks to exit
- [ ] (productionize) add configurablerate limiting to RPCs with backpressure
- [ ] (productionize) RocksDB durability/tuning surfaced via config: WAL sync policy, background jobs, compaction, block cache, rate limiter, max open files
- [ ] (productionize) data directory hardening: avoid /tmp default, permissions/ownership checks, separate WAL dir, disk space checks
- [ ] (productionize) admin operations: safe drain, purge, and stats endpoints
- [ ] (productionize) abstract a mockable clock for leases/visibility to enable deterministic tests
- [X] (productionize) release profile tuning: LTO, codegen-units, panic=abort (if acceptable), symbol levels
- [X] (productionize) packaging: Dockerfile (non-root, minimal base, HEALTHCHECK), multi-arch builds
- [ ] (productionize) Kubernetes/Helm: liveness/readiness probes, resource limits/requests, PDB, PV, ConfigMap-based configuration
- [ ] (productionize) systemd unit: restart policy, sandboxing, rlimits, service user/group
- [X] (productionize) repository hygiene: add LICENSE and CONTRIBUTING.md
- [X] (productionize) update README
