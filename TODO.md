# TODOs (beyond inline comments)

- [X] (minor) make newtype safety stuff for db keys
- [X] (minor) set the rocksdb setting that helps with prefix scans
- [X] (minor) proper command setup (cli args, etc)
- [X] (minor) ci
- [X] (major) server concurrency (either normally or via partitioning)
- [X] (major) server parallelism
- [X] (major) move storage to an io thread pool
- [X] (feat) implement lease expiry via a background thread
- [X] (feat) implement poll in server
- [X] (minor) add polling timeout and num_items options
- [X] (major) fix race condition: concurrent polls can hand out the same messages
- [X] (feat) implement remove
- [X] (feat) implement extend
- [X] (bugfix) e2e benchmark hangs / improve benchmarks
- [X] (bugfix) polling returns early if it's woken by a new message being added, *even if it isnt visible*.
- [X] (bugfix) poll-waiting isnt interrupted when a message becomes visible
- [X] (minor) clean up cursed client stress mode
- [X] (minor) integrate tokio console into queueber
- [X] (bugfix) stress test found this error with num workers = 4: `database integrity violated: main key not found`. fix it.
- [ ] (minor) perf analysis on queueber while being stressed
- [X] (minor) make sure all storage stuff happens within a spawn_blocking or similar
- [ ] (minor) rocksdb settings tuning
- [X] (test) add extend to fuzz test and stress
- [ ] (major) server/storage sharding
- [ ] (major) fix server parallelism -- it's not right currently
- [X] (major) make sure there's only one copy of each background task running in the system
- [X] (bugfix) why does the server just shut down under stress after a while with exit code 0 ...
- [X] (perf) add `--workers` CLI flag and name RPC worker threads
- [ ] (perf) improve performance
- [ ] (perf) improve poll wakeups
- [ ] (perf) per-worker accept via `SO_REUSEPORT`
- [ ] (perf) buffer/message reuse to reduce allocations on hot paths (if that makes sense for capnp)
- [X] (minor) rename keys to ids in `LeaseEntry`, or actually put keys in there. either way
- [X] (minor) make `add_available_item_from_parts` wrap `add_available_items_from_parts`, not the other way around
- [ ] (minor) use a mockable clock when generating uuidv7s
- [ ] (perf) reduce unnecessary allocs, such as when copying data or allocating buffers. some is called out in code comments
- [ ] (perf) sort the keys in `LeaseEntry` so we can do bsearch on them
- [ ] (major) ensure `extend` doesnt create multiple index entries for the same lease.
- [ ] (perf) add lease expiry index key to `LeaseEntry` so we don't have to do scans to find it when extending
- [X] (bugfix) i still get `assertion failed: main key not found: [97, 118, 97, 105, 108, 97, 98, 108, 101, 47, 1, 152, 216, 213, 36, 239, 114, 179, 154, 59, 190, 29, 213, 115, 111, 117]"` from poll requests when running with high concurrency. even now that we use a snapshotted txn in poll.
